<!-- templates/auth/usuario_editar.html -->
{% extends "base.html" %}

{% block title %}{{ 'Editar' if usuario else 'Novo' }} Usuário{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-user-edit me-2"></i>
                {{ 'Editar Usuário' if usuario else 'Novo Usuário' }}
            </h1>
            <p class="text-muted mb-0">
                {{ 'Edite as informações do usuário' if usuario else 'Crie um novo usuário no sistema' }}
            </p>
        </div>
        <div>
            <a href="{{ url_for('auth.listar_usuarios') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações do Usuário
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label">
                                    <i class="fas fa-user me-1"></i>Nome Completo *
                                </label>
                                <input type="text" class="form-control" id="nome" 
                                       name="nome" required
                                       value="{{ usuario.nome if usuario else form_data.nome or '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe o nome completo.
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email *
                                </label>
                                <input type="email" class="form-control" id="email" 
                                       name="email" required
                                       value="{{ usuario.email if usuario else form_data.email or '' }}"
                                       data-verify-url="{{ url_for('auth.api_verificar_email', email='') }}"
                                       data-exclude-id="{{ usuario.id if usuario else '' }}">
                                <div class="invalid-feedback">
                                    Por favor, informe um email válido.
                                </div>
                                <div class="form-text" id="email-feedback"></div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="username" class="form-label">
                                    <i class="fas fa-user-circle me-1"></i>Nome de Usuário *
                                </label>
                                <input type="text" class="form-control" id="username" 
                                       name="username" required minlength="3"
                                       value="{{ usuario.username if usuario else form_data.username or '' }}"
                                       data-verify-url="{{ url_for('auth.api_verificar_username', username='') }}"
                                       data-exclude-id="{{ usuario.id if usuario else '' }}">
                                <div class="invalid-feedback">
                                    Nome de usuário deve ter pelo menos 3 caracteres.
                                </div>
                                <div class="form-text" id="username-feedback"></div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="tipo_usuario" class="form-label">
                                    <i class="fas fa-user-tag me-1"></i>Tipo de Usuário *
                                </label>
                                <select class="form-select" id="tipo_usuario" name="tipo_usuario" required>
                                    <option value="usuario" {% if (usuario and usuario.tipo_usuario == 'usuario') or (form_data.tipo_usuario == 'usuario') %}selected{% endif %}>
                                        Usuário
                                    </option>
                                    <option value="admin" {% if (usuario and usuario.tipo_usuario == 'admin') or (form_data.tipo_usuario == 'admin') %}selected{% endif %}>
                                        Administrador
                                    </option>
                                </select>
                                <div class="form-text">
                                    Administradores têm acesso total ao sistema.
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="ativo" name="ativo"
                                           {% if (usuario and usuario.ativo) or (form_data and form_data.ativo == 'on') %}checked{% endif %}>
                                    <label class="form-check-label" for="ativo">
                                        Usuário ativo
                                    </label>
                                </div>
                                <div class="form-text">
                                    Usuários inativos não podem fazer login.
                                </div>
                            </div>
                        </div>

                        {% if not usuario %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Uma senha temporária será gerada automaticamente para este usuário.
                        </div>
                        {% endif %}

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-save me-2"></i>
                                {{ 'Atualizar' if usuario else 'Criar Usuário' }}
                            </button>
                            <a href="{{ url_for('auth.listar_usuarios') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            {% if usuario %}
            <!-- Additional Options -->
            <div class="row mt-4">
                <!-- Password Reset -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 fw-bold text-warning">
                                <i class="fas fa-key me-2"></i>Redefinir Senha
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                Gere uma nova senha temporária para este usuário.
                            </p>
                            <button type="button" class="btn btn-warning" 
                                    data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
                                <i class="fas fa-key me-2"></i>Redefinir Senha
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Account Status -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 fw-bold {{ 'text-success' if usuario.ativo else 'text-danger' }}">
                                <i class="fas fa-user-{{ 'check' if usuario.ativo else 'slash' }} me-2"></i>
                                Status da Conta
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                Usuário está <strong>{{ 'ativo' if usuario.ativo else 'inativo' }}</strong>.
                                {% if usuario.ativo %}
                                Pode fazer login no sistema.
                                {% else %}
                                Não pode fazer login no sistema.
                                {% endif %}
                            </p>
                            {% if usuario.id != current_user.id %}
                            <form method="POST" 
                                  action="{{ url_for('auth.excluir_usuario' if usuario.ativo else 'auth.reativar_usuario', id=usuario.id) }}"
                                  class="d-inline">
                                <button type="submit" class="btn {{ 'btn-danger' if usuario.ativo else 'btn-success' }}">
                                    <i class="fas fa-user-{{ 'slash' if usuario.ativo else 'check' }} me-2"></i>
                                    {{ 'Desativar' if usuario.ativo else 'Reativar' }} Conta
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reset Password Modal -->
            {% if usuario.id != current_user.id %}
            <div class="modal fade" id="resetPasswordModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-key me-2"></i>Redefinir Senha
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Tem certeza que deseja redefinir a senha do usuário 
                               <strong>{{ usuario.nome }}</strong>?</p>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Uma nova senha temporária será gerada e exibida na tela.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" 
                                    data-bs-dismiss="modal">Cancelar</button>
                            <form method="POST" 
                                  action="{{ url_for('auth.resetar_senha_usuario', id=usuario.id) }}">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-key me-1"></i>Redefinir Senha
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Real-time username validation
    $('#username').on('blur', function() {
        var username = $(this).val();
        var excludeId = $(this).data('exclude-id');
        var url = $(this).data('verify-url') + username;
        
        if (username.length < 3) return;
        
        if (excludeId) {
            url += '?excluir_id=' + excludeId;
        }
        
        $.getJSON(url, function(data) {
            var feedback = $('#username-feedback');
            if (data.disponivel) {
                $(this).removeClass('is-invalid').addClass('is-valid');
                feedback.removeClass('text-danger').addClass('text-success')
                    .html('<i class="fas fa-check-circle"></i> Nome de usuário disponível');
            } else {
                $(this).removeClass('is-valid').addClass('is-invalid');
                feedback.removeClass('text-success').addClass('text-danger')
                    .html('<i class="fas fa-times-circle"></i> Nome de usuário já em uso por ' + data.usuario.nome);
            }
        }.bind(this));
    });
    
    // Real-time email validation
    $('#email').on('blur', function() {
        var email = $(this).val();
        var excludeId = $(this).data('exclude-id');
        var url = $(this).data('verify-url') + email;
        
        if (!email.includes('@')) return;
        
        if (excludeId) {
            url += '?excluir_id=' + excludeId;
        }
        
        $.getJSON(url, function(data) {
            var feedback = $('#email-feedback');
            if (data.disponivel) {
                $(this).removeClass('is-invalid').addClass('is-valid');
                feedback.removeClass('text-danger').addClass('text-success')
                    .html('<i class="fas fa-check-circle"></i> Email disponível');
            } else {
                $(this).removeClass('is-valid').addClass('is-invalid');
                feedback.removeClass('text-success').addClass('text-danger')
                    .html('<i class="fas fa-times-circle"></i> Email já cadastrado por ' + data.usuario.nome);
            }
        }.bind(this));
    });
    
    // Form validation
    (function() {
        'use strict'
        
        var forms = document.querySelectorAll('.needs-validation')
        
        Array.prototype.slice.call(forms)
            .forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })();
});
</script>
{% endblock %}