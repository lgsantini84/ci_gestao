{% extends "base.html" %}

{% block title %}Importar Dados - Sistema CI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-file-import me-2"></i>Importar Dados
        </h1>
        <a href="{{ url_for('import.historico_importacoes') }}" class="btn btn-outline-primary">
            <i class="fas fa-history me-1"></i>Ver Historico
        </a>
    </div>

    <!-- Informacoes -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-info-circle me-1"></i> Informacoes sobre Importacao
        </div>
        <div class="card-body">
            <p>Use esta pagina para importar dados de diferentes fontes. O sistema suporta os seguintes formatos:</p>
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-file-excel me-2"></i>Excel/CSV
                            </h6>
                            <ul class="mb-0 small">
                                <li>Colaboradores Ativos</li>
                                <li>Colaboradores Desligados</li>
                                <li>Planos de Saude</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title text-success">
                                <i class="fas fa-file-pdf me-2"></i>PDF
                            </h6>
                            <ul class="mb-0 small">
                                <li>Odontoprev - Fatura</li>
                                <li>Extratos detalhados</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title text-info">
                                <i class="fas fa-database me-2"></i>Operadoras
                            </h6>
                            <ul class="mb-0 small">
                                <li>Unimed</li>
                                <li>Hapvida</li>
                                <li>Odontoprev</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Upload -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-upload me-1"></i> Upload de Arquivos
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" action="{{ url_for('import.importar') }}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Tipo de Importacao *</label>
                        <select name="tipo" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="ATIVOS">Colaboradores Ativos</option>
                            <option value="DESLIGADOS">Colaboradores Desligados</option>
                            <option value="UNIMED">Unimed</option>
                            <option value="HAPVIDA_SAUDE">Hapvida Saude</option>
                            <option value="HAPVIDA_ODONTO">Hapvida Odonto</option>
                            <option value="ODONTOPREV">Odontoprev</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Empresa</label>
                        <select name="empresa" class="form-select">
                            <option value="">Selecione...</option>
                            {% if valid_company_codes %}
                                {% for code, name in valid_company_codes.items() %}
                                <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            {% else %}
                            <option value="PSF">PASCHOALOTTO</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Subtipo (opcional)</label>
                        <select name="subtipo" class="form-select">
                            <option value="">Nenhum</option>
                            <option value="COPARTICIPACAO">Coparticipacao</option>
                            <option value="MENSALIDADE">Mensalidade</option>
                            <option value="FATURA">Fatura</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Arquivos *</label>
                    <input type="file" name="arquivos[]" class="form-control" multiple required
                           accept=".csv,.xlsx,.xls,.pdf">
                    <div class="form-text">
                        Formatos aceites: CSV, Excel (.xlsx, .xls), PDF. Tamanho maximo: {{ (max_content_length / 1024 / 1024)|round(1) if max_content_length else 16 }}MB
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i> Importar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ultimas Importacoes -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-history me-1"></i> Ultimas Importacoes
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tipo</th>
                            <th>Arquivo</th>
                            <th>Status</th>
                            <th>Registros</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if importacoes %}
                            {% for imp in importacoes %}
                            <tr>
                                <td>{{ imp.data_importacao|to_brasilia|strftime('%d/%m/%Y %H:%M') if imp.data_importacao else '-' }}</td>
                                <td><span class="badge bg-info">{{ imp.tipo_importacao }}</span></td>
                                <td>{{ imp.arquivo or '-' }}</td>
                                <td>
                                    {% if imp.status == 'SUCESSO' %}
                                    <span class="badge bg-success">Sucesso</span>
                                    {% elif imp.status == 'ERRO' %}
                                    <span class="badge bg-danger">Erro</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ imp.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ imp.linhas_processadas or 0 }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Nenhuma importacao realizada</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
